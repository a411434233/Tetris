<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    #box {
        width: 400px;
        height: 600px;
        border: solid 1px;
        position: relative;
        transform: scale(0.5);
    }

    #item {
        width: 20px;
        height: 20px;
    }

    .showColor {
        background: black;
    }

</style>
<body>
<div id="box"></div>
</body>
<script>
  const customBlock = {
    '1': [
      [1, 1],
      [1, 1]
    ],
    '2': [
      [1, 1, 0],
      [0, 1, 1]
    ],
    '3': [
      [0, 1, 1],
      [1, 1, 0]
    ],
    '4': [
      [1, 1, 1, 1]
    ],
    '5': [
      [1, 1],
      [0, 1],
      [0, 1]
    ],
    '6': [
      [1, 1],
      [1, 0],
      [1, 0]
    ],
    '7': [
      [0, 1, 0],
      [1, 1, 1]
    ]
  }

  class gameBox {
    constructor() {
      this.box = document.getElementById('box')
      this.height = 30
      this.width = 20
      this.smallBlock = {
        width: '20px',
        height: '20px'
      }
      this.shoa = []
      this.createBox()
    }

    createBox() {
      for (let n = 0; n < this.height; n++) {
        const divElement = document.createElement('div')
        divElement.style.display = 'flex'
        const children = []
        for (let m = 0; m < this.width; m++) {
          let div = document.createElement('div')
          Object.assign(div.style, this.smallBlock)
          div.show = 0
          divElement.appendChild(div)
          children.push(div)
        }
        this.shoa.push(children)
        this.box.appendChild(divElement)
      }
    }

    addItems(item) {
      let y = item.y + item.data.length - 1
      for (let n = item.data.length - 1; n >= 0; n--) {
        for (let m = 0; m < item.data[n].length; m++) {
          if (item.data[n][m] === 1) {
            this.shoa[y][item.x + m].className = 'showColor'
            this.shoa[y][item.x + m].show = 1
          }
        }
        y -= 1
      }
      this.isSuccessLine()
    }


    isSuccessLine() {
      this.shoa.forEach((value, index) => {
        const successLine = value.every(item => item.show === 1)
        if (successLine) {
          const divs = document.createElement('div')
          divs.style.display = 'flex'
          const arr = []
          for (let m = 0; m < this.width; m++) {
            let div = document.createElement('div')
            Object.assign(div.style, this.smallBlock)
            div.show = 0
            divs.appendChild(div)
            arr.push(div)
          }
          this.shoa.push(arr)
          this.box.removeChild(this.shoa[index])
          this.shoa.splice(index, 1)
        }
      })
    }

    isDownEndLine(item) {
      const som = item.y + item.list.length >= this.height
      if (som) return true
      for (let index = 0; index < item.data.length; index++) {
        let value = item.data[index]
        if (this.shoa[value + 1] && this.shoa[value + 1][item.x + index].show === 1 && item.y <= 0) {
          return 'gameOver'
        }
        if (this.shoa[value + 1] && this.shoa[value + 1][item.x + index].show === 1) {
          return true
        }
      }
      return false
    }
  }

  class block {
    constructor() {
      this.box = $box.box
      this.x = 0
      this.y = 0
      this.item = []
      this.close = false
      this.speed = 1000
      this.createBlock()
      document.addEventListener('keydown', (e) => {
        if (this.close) return
        if (this.getArrEndItem()) return this.close = true
        // 旋转90
        if (e.code === 'Space') {
          this.rotate(this.item)
        }
        //右移动一格
        if (e.code === 'ArrowRight') {
          this.toRight()
        }
        //左移动一格
        if (e.code === 'ArrowLeft') {
          this.toLeft()
        }
        //下降一格
        if (e.code === 'ArrowDown') {
          this.ArrowDown()
        }
      })
    }

    getArrEndItem() {
      let arrEndItem = JSON.parse(JSON.stringify(this.item[this.item.length - 1]))
      let arr = new Array(arrEndItem.length).fill(this.y + this.item.length - 1)
      for (let n = 0; n < arrEndItem.length; n++) {
        if (arrEndItem[n] === 0) {
          let index = this.item.length - 1
          while (arrEndItem[n] === 0) {
            index -= 1
            arr[n] -= 1
            arrEndItem[n] = this.item[index][n]
            if (index < 0) return
          }
        }
      }
      return $box.isDownEndLine({ x: this.x, y: this.y, data: arr, list: this.item })
    }


    allDowns() {
      const flag = this.getArrEndItem()
      if (flag === 'gameOver') return
      if (flag) {
        this.close = true
        $box.addItems({ x: this.x, y: this.y, data: this.item })
        this.box.removeChild(this.block)
        this.createBlock()
      } else {
        this.ArrowDown()
        setTimeout(this.allDowns.bind(this), this.speed)
      }
    }


    getBlockRightMargin() {
      let flag = true
      for (let index = 0; index < this.item.length; index++) {
        let rightIndex = this.item[index].length - 1
        while (this.item[index][rightIndex] !== 1) {
          rightIndex -= 1
          if (rightIndex === 0) break
        }
        if ($box.shoa[this.y + index][this.x + (rightIndex + 1)].show === 1) flag = false
      }
      return flag
    }

    toRight() {
      if (this.x + this.item[0].length === $box.width) return
      if (!this.getBlockRightMargin()) return
      this.x += 1
      this.block.style.left = this.x * 20 + 'px'
    }


    getBlockLeftMargin() {
      let flag = true
      for (let index = 0; index < this.item.length; index++) {
        let itemArr = this.item[index]
        let leftIndex = itemArr.findIndex(value => value === 1)
        if ($box.shoa[this.y + index][this.x - (leftIndex - 1)].show === 1) flag = false
      }
      return flag
    }

    toLeft() {
      if (this.x === 0) return
      if (!this.getBlockLeftMargin()) return
      this.x -= 1
      this.block.style.left = this.x * 20 + 'px'
    }

    ArrowDown() {
      if (this.y + this.item.length >= $box.height) return this.close = true
      this.y += 1
      this.block.style.top = this.y * 20 + 'px'
    }

    createBlock() {
      this.block = document.createElement('div')
      this.appendDiv = []
      this.x = 8
      this.y = 0
      this.item = this.getItem()
      this.create()
      $box.box.appendChild(this.block)
      this.close = false
      this.allDowns()
    }

    create() {
      this.block.style.width = this.item[0].length * 20 + 'px'
      this.block.style.position = 'absolute'
      this.block.style.display = 'grid'
      this.block.style.left = `${this.x * 20}px`
      this.block.style.gridTemplateColumns = `repeat(${this.item[0].length},1fr)`
      this.block.style.gridTemplateRows = `repeat(${this.item.length},1fr)`
      for (let n = 0; n < this.item.length; n++) {
        this.item[n].forEach(val => {
          let div = document.createElement('div')
          div.className = 'item'
          Object.assign(div.style, $box.smallBlock)
          div.style.background = val ? 'black' : ''
          this.appendDiv.push(div)
          this.block.appendChild(div)
        })
      }
    }

    getItem() {
      const config = Object.keys(customBlock)
      const index = parseInt((Math.random() * config.length + 1).toString())
      return customBlock[index]
    }

    rotate(arr) {
      this.appendDiv.forEach(val => {this.block.removeChild(val)})
      this.appendDiv = []
      const newArr = []
      for (let n = 0; n < arr[0].length; n++) {
        let arr2 = []
        for (let m = arr.length - 1; m >= 0; m--) arr2.push(arr[m][n])
        newArr.push(arr2)
      }
      this.item = newArr
      this.create()
    }
  }

  const $box = new gameBox()
  new block()
</script>
</html>
